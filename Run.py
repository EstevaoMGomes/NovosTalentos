# To activate the virtual environment: source NovosTalentos/bin/activate

import jax
import jax.numpy as jnp
from jax.experimental.ode import odeint
from jax import jit, vmap, pmap
from jax.lax import fori_loop, scan, select
from simsopt.field import BiotSavart, Current, Coil
from simsopt import load
import numpy as np
from time import time
from functools import partial
import matplotlib.pyplot as plt
import matplotlib.animation as animation

from src.Dynamics import GuidingCenter
from src.MagneticField import B, B_Norm, B_novo, grad_B
from src.CreateCoil import CreateCoil
from src.Plotter import plot3D, plot2D, plot_animation3d
from simsopt.geo import CurveXYZFourier

def oldCreateCoil(FourierCoefficients: list[int | float], NumberOfPoints: int, order: float) -> CurveXYZFourier:
    # Creating a curve with "NumberOfPoints" points and "order" number of Fourier coefficients
    curve = CurveXYZFourier(NumberOfPoints, order=order)
    # Setting the Fourier coefficients
    curve.x = FourierCoefficients
    return curve

debuging = False
#------------------------------------------------------------------------#
# Inputs
#------------------------------------------------------------------------#

N_particles = 10
#FourierCoefficients = [[-1., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 1., 0., 0.,],[1., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 1., 0., 0.,]]
FourierCoefficients = [[-2., 0., 0, 0., 1., 0., 0., 0., 1.], [2., 0., 0., 0., 1., 0., 0., 0., 1.]]
#FourierCoefficients = [[-1.39877820e+01,  9.73827622e-02, -2.04908605e+00, -1.41725830e-01,
#  4.56845054e+00, -2.32155126e-03,  1.32708122e+00,  2.58179468e-01,
#  3.05903007e+00], [-1.51871837e+00, -3.05514491e+00,  6.77326222e-01,
# -1.34030161e+01, -1.01064459e+01,  2.96167674e+00,  2.29916623e+00,
#  2.68320389e+00, -2.02021051e+00]]
#FourierCoefficients = [[-13740614718.929352, 45010001.478988245, -2546633035.205666, 96708340.3263575, 3318424872.9081783, 56425454.87037025, 394183734.8469013, 89046620.86249365, 3500784670.058241], [-2696078547.829357, -7142264944.76991, 1369023895.2295704, -7786834069.593535, -14305665912.815304, 2545483309.155122, 1266318197.132097, 2373091734.687136, -3161998497.9020004]]
#FourierCoefficients = [[-2.105436767037876, 0.16540488329413466, -0.37822677806631755, -0.07562983995169222, 1.0386110537889908, -0.002546577154512729, -0.007698645808491838, -0.0029953834138113124, 0.9946516230694082], [0.8673039028909039, 0.03449993429305001, 0.03660480002495869, -0.027350596766373882, 0.4796513442381621, -0.031708014247428744, -0.12725927105681636, -0.018898924058447703, 0.44847597843629555]]
#FourierCoefficients = [[-2.147869397377754, 0.18268509104539, -0.389534664865396, 0.09630831753511991, -0.06310516552734853, -0.07635853572069998, 1.057732159083316, -0.019875193041674514, -0.05769982161346997, 0.013816961192643097, -0.003469770645142031, -0.014721939786353663, 1.0404787735329102, -0.003288229042236649, -0.06972945482360222], [0.8854020210856544, 0.007529709255217744, 0.012680877828184785, -0.03948909766063804, 0.022531239425347172, -0.033125423689350376, 0.44673917656716056, -0.059030657960613436, -0.11965553667924496, -0.07499512969218892, -0.1431894887997557, -0.04413417880890023, 0.4234527802784654, 0.03198968374874773, -0.14881502704764882 ]]

FourierCoefficients = [[-1.8746883002172272, 0.00919390981009342, -0.010681154782432757, -0.0019821267370478224, 0.00011889160187998762, -0.0020990015935972014, 0.001982106015646127, 0.013726948728579358, 1.125182668589405, 0.002868998546910861, 0.02079667646759333, -0.0024710250154603712, 0.025211227137632023, 0.004306320881117695, -0.00782880054131793, 0.0015650786337092727, 1.1017660778948344, 0.00830019497644951, -0.00928488444917999, 0.003781748043543047, -0.01124483287745919], [1.8746883002172272, 0.00919390981009342, -0.010681154782432757, -0.0019821267370478224, 0.00011889160187998762, -0.0020990015935972014, 0.001982106015646127, 0.013726948728579358, 1.125182668589405, 0.002868998546910861, 0.02079667646759333, -0.0024710250154603712, 0.025211227137632023, 0.004306320881117695, -0.00782880054131793, 0.0015650786337092727, 1.1017660778948344, 0.00830019497644951, -0.00928488444917999, 0.003781748043543047, -0.01124483287745919]]

#FourierCoefficients = [[-1.218925387828992, -0.002801286974587578, -0.004838642145847803, -0.008924873796238495, 0.007389075652447792, -0.0002847792442128649, 0.004470730185163476, -0.051148147716136, 0.8738088009436316, 0.01135136464901896, 0.049525538794861185, 0.02409928283357205, 0.011356459098402352, -0.005722558941984067, 0.08324409547481337, 0.01035205528344201, 0.8616590715152666, -0.025461134716604356, 0.03796286228005088, 0.00922409686862832, -0.004651945497331838], [1.4771751424204553, 0.03981571409830538, -0.16597304349841394, -0.10645120132143934, 0.0017527704832195588, -0.009571499568316983, -0.025168851046942938, 0.43331404925752054, 0.9482956559762938, -0.042735856895952225, 0.1542298352620084, -0.10603080016486552, -0.03348291498989099, -0.09303330519718032, 0.028215235585928644, 0.007570792278128409, 0.8505832125573539, 0.15394040193834002, -0.017163869793269476, -0.06843962818595095, -0.10964194059369636]]
#FourierCoefficients = [[0.17098171428475298, 0.3374664716941216, -0.1254909655142695, -0.2946331032226744, -0.2622842753241998, -0.048973187270651315, 0.3497800923875128, -0.20195369438508406, 2.224162642944778, 0.07667493386512471, 0.4336633989054364, 0.10152596132329153, 0.19384256152484083, -0.09584734662997382, 0.3751829303911688, 0.08980776251682004, 2.161862082851838, -0.11547037379984784, 0.059507984463074474, 0.06412364269552938, -0.015192303015270617], [1.9838731502546585, 0.3220855891292415, -0.43852908876475594, -0.2810368529307607, -0.033568746137648375, 0.10279755055341273, 0.070932160835276, 0.0002818446146837656, 0.3713449807083593, 0.0609309044426282, -0.015151357739235734, -0.060592243757987066, -0.18420303852088024, -0.08585925882706437, 0.2629006022117243, 0.0764272877802948, 0.2651424467979431, -0.03575518750264098, 0.17674754530131961, 0.05051082210043819, -0.04370612317967714]]
#FourierCoefficients = [[0.9363160823371461, 0.22945352019525653, 0.13644887470577594, 0.13550323536037437, -0.08674692845060263, 0.0073371441857738905, 0.09506201066035722, 0.057357910012399205, 0.031039081659734735, 0.014129389588067923, -0.005062505519718154, 0.0901549463114622, -0.06280246293161637, 0.05209426368282848, -0.12317552760700402, 0.08698339686268315, -0.1213484225772738, 0.16242793336754127, -0.3669418267584414, 0.024267288160359578, -0.2701384681148934, -0.22391264829892557, 5.395255864949775, 0.018158102469318718, 1.2433194914662804, 0.07112153569342836, 0.5638811449795931, 0.0023749675976458616, 0.7362085786489981, 0.055519821813537686, 0.8465979661204796, 0.09530562904397986, 0.9535069799428194, 0.13441734471260386, 1.0305879026785325, 0.17861539642974106, 1.1500404826745856, 0.24285276080702745, 0.8439701281423975, 0.3470200879949438, 1.0368209587707309, 0.17946071024403942, 1.24597723393261, 0.06773639897339072, 4.79054064355561, -0.09901041108646096, 0.4862225510902444, 0.09675194280729793, -0.40896994160772904, 0.039235147654269796, -0.46202397559337915, 0.11865643060414509, -0.4116087520879232, 0.023236989619806393, -0.35179744389952733, 0.0929571500495302, -0.23918120695763637, 0.01021501195375421, -0.19688277341212562, 0.06751494226234275, 0.45196347289751704, -0.1161858395100645, 0.10171726228419621], [6.431594872687778, 1.3435891520836485, -2.1233010870492772, -1.0258478293227462, -0.10600188041194553, 0.6111813960733613, -0.1924322813148625, 0.10522475873164316, -0.507985020338485, 0.23911533917312655, -0.2524247038252781, 0.3779385895390366, -0.16412275017810476, 0.30886707027212357, 0.25356589457805145, 0.12148323129514431, 0.6466444915636175, -0.16248631646811032, 0.8840702618719827, -0.4999526818974457, 0.5944312056943082, -0.5406913237642073, -1.2001598963007392, 0.17477958072134575, -0.09463604591151567, 0.16094249802041308, -0.39839097738607177, -0.22852477758566261, -0.32845868061325767, -0.03977040430452742, -0.33830670296596, 0.010940827015494387, -0.5114179702587887, 0.07128541334434878, -0.7067763779783527, -0.013060741380347456, -0.7817840695726995, -0.11298431239857139, -0.8917827519022453, -0.09252350995439423, -1.089805726199717, -0.17567087857759725, 1.1070127063046116, -0.07159397873677295, -0.5763172349019215, -0.6489950647630096, 0.6777639139799115, -0.2639478980463597, 0.3042200360163798, -0.37819736863324904, 0.19196492369014642, -0.2766336990080768, 0.10108517711712789, -0.2269334980537772, -0.0768831026184212, -0.10389139204947373, -0.288883252503007, 0.09164258519615683, -0.4217064765347499, 0.24699003614332812, -0.25807721896846, 0.11550055091354255, -0.025519978578944415]]
#FourierCoefficients = [[0.9716100662340352, 0.2110860454002413, 0.16283593163247373, 0.15411471912900715, -0.06691801432292764, -0.0029373880006955014, 0.09723548210233868, 0.0673265910987589, 0.03923152558937332, 0.008524096891345086, 0.004257085688118845, 0.10138969873646432, -0.05246587680664194, 0.03894010011171865, -0.10412755255022385, 0.10259819081350802, -0.10086185864891908, 0.15220607128689242, -0.3573092051130282, 0.010582769663117343, -0.25903250452262283, -0.22609564782630756, 5.384675587091951, 0.01838572076181116, 1.2529299640143747, 0.06335109230651022, 0.5685318098233262, 0.002835424569929067, 0.7455511431183282, 0.04977722248864554, 0.8505359880206114, 0.09791021308516157, 0.9590885444030194, 0.12637202834590197, 1.0278524576474144, 0.17775086679272137, 1.165321760121564, 0.24382952755556947, 0.8070416925400721, 0.3481998876746958, 1.0257085822984762, 0.16088973486540833, 1.2840353415685895, 0.06546402725733977, 4.7773756946727, -0.09785235320749316, 0.49989075778499664, 0.0973695425570899, -0.4103656308503562, 0.034974267595065, -0.46204255432526997, 0.12530722461190294, -0.41898777000506016, 0.011472196117156873, -0.35918196888432663, 0.09778400296997684, -0.2405170467108223, 0.014017461819261076, -0.2295354466603961, 0.06773353395936109, 0.46810764103273766, -0.10916176170089982, 0.06466491454692387], [6.434876238129391, 1.3490455827459835, -2.138692358426245, -1.0243635933629167, -0.10495137381603548, 0.6012320206127592, -0.19473455388475727, 0.10545687589208314, -0.5351511284598174, 0.2704985345423045, -0.2701545113630858, 0.4107653182761968, -0.15513311153871434, 0.3288974059491514, 0.2770983097052799, 0.11768137328099795, 0.6790732587222946, -0.19290846064828282, 0.8955618728972636, -0.5200570337015163, 0.5751110098215997, -0.5571222768374269, -1.1977996462187361, 0.1666206681973454, -0.07986505469240138, 0.17112831260924494, -0.38927237831019024, -0.20588644713470994, -0.3307716503289214, -0.023604036045967707, -0.34229965480014707, 0.003382116046352195, -0.49785968347604037, 0.05469672936993714, -0.6927628437132799, -0.01012046556835005, -0.7891195003149337, -0.10983539126366665, -0.8929175330113367, -0.10154140836297729, -1.086937058732045, -0.17041846037800104, 1.1096854305946735, -0.06977420666847185, -0.569408877810451, -0.6720594997492022, 0.6920633447927259, -0.2915570033195885, 0.28504259850584307, -0.37311886669238015, 0.16341060117922884, -0.26790383276185775, 0.10441359109419675, -0.24524711269098995, -0.07205854749941736, -0.1119107996261085, -0.31153775580846627, 0.11325840169874529, -0.4447454659204051, 0.2604248875445836, -0.27131917447626075, 0.10530080555409976, -0.04942212588834434]]
#FourierCoefficients = [[59.30676862866394, 4.256251740972387, 12.254433355898056, -2.340217867553637, 5.3497581034498385, 3.558335773085275, 1.8664206789940194, 0.5776751358158612, 5.11123029366672, 0.8140016010749903, 8.804928605721523, -0.694232729858978, 12.926817610410918, -0.6589488640287532, 22.42103247975089, -10.35634084382288, 36.10452616377507, -5.000940285089587, 45.87655281698453, -5.519571930329766, -8.288149671707652, -5.319391617119167, 18.722233287232992, -0.03146686051691013, 19.35888144988195, 1.8910096442454583, 12.78237983683425, -1.1841708138183638, 10.354630393397622, 1.8934216675871192, 10.257931554886158, -0.05582907028347653, 1.0586623988931914, 0.9674652744930005, 1.4858665986702162, -2.873159172283146, -8.88716474360514, -3.4075997934935596, -9.019933867743289, 2.350970014552754, -14.040912112682655, -9.895037431637569, 23.491819216256406, 0.1655028697269737, 28.608212460764413, -1.813305074676488, 10.172385985939687, 0.490381527392621, 5.9976412693974135, 1.1970876854004993, -5.496219692614193, 0.41160596063353666, -4.862745776182263, 0.5734595485684653, -0.3984851621667638, -0.8773989927966532, -0.3316616689940327, -2.892072409588203, 9.410672441154112, 4.586769091301555, -0.461619118160886, 1.2157876779012213, -14.121732786975834], [-21.577344965746565, 20.12768875355706, -21.074562955379232, 9.882011166164641, 2.0731311040585396, -5.611349037227861, 7.577894489650155, -17.924627271170245, -3.3801649555637825, -13.57020042695147, -15.727983028476068, 2.0612844264951544, -17.498639240404692, 17.035472406664077, 0.5170514519097336, 20.34684484253194, 33.8160361138402, 0.49188701541823665, 66.50360879310509, -39.03528354040378, 43.013372585180356, 6.0643048461349665, -1.3614986969553902, 12.135913900638988, -6.740094556368208, 0.9428389751719676, -2.092000159878907, -2.1174338488020887, 2.9874943110156957, -2.501299815171407, 6.071625881528311, 0.3970123687256962, 2.3485557240511166, 6.386811255401271, -9.770104061874243, 11.841397807417767, -28.54349857029227, 9.00684377602447, -37.75014670456432, -12.116870392579415, -13.116149942719924, -27.617591328042298, 16.090525088241918, -0.17294758129807913, 7.713697515074838, 1.40786246856501, 5.484802634828828, 4.441084239456107, 6.064508506115055, 4.453604839578059, 5.5456014832998415, 3.937336292172818, 1.1947111242552078, 3.0500377821427413, -6.416791761975585, 0.3497573461390069, -18.390846133646452, -1.7695099308707167, -35.592277985516915, 2.3343820060025644, -45.03133650965195, 6.414242421915217, -27.15000418489375]]

FourierCoefficients = [[0.9406551549012973, 0.015953718304280308, 0.49407949661710737, -0.023977282051317016, 0.008143131720680034, -0.0005588995597989721, -0.01601208422113381, 0.3373250559386986, -0.04561716840972937, 0.07302281009735169, 0.0755644170416564, -0.02603460500808737, 0.0071681766828212146, 0.055417863569896086, -0.003458584813758479, -0.4877787909112782, -0.0012505189215781727, 0.0021751561849660066, 0.0025752796959366657, -0.00012946446302788796, 0.0004970911030514533], [0.6061536535466535, 0.035217676371165865, 0.34775400024751535, -0.061859029236755084, 0.02413031785813937, -0.00568211118945103, -0.046973521346034004, 0.8117342632648841, -0.03112255838439744, 0.3304315765186676, 0.059238575587262414, -0.010680212255805411, -0.001445656580441313, 0.037139356630544636, -0.023240031858946415, -0.4676835097482277, 0.004190606691483121, -0.007515515195938398, 0.011049928990040784, -0.0017528141860599978, -0.004696255051483464], [0.2712177622153074, -0.13547878453236, 0.06194360436821792, -0.051079384199852175, -0.06921634110301877, 0.0360631664226348, -0.03529636968491051, 1.0137151697479545, -0.008411289356326717, 0.5603080009657191, -0.01829472748709407, 0.0019106928429153507, -0.010181965253959813, -0.012870719087183367, 0.04180343654142911, -0.5868104691904066, 0.009887218756057138, -0.020210967088526512, -0.020511590944730845, -0.003556127591405815, -0.006380728738608314], [-0.7238230370899528, 0.04447291777540339, -0.2743815207318627, -0.02215667983149752, 0.016569620320189247, -0.00045486440070145105, -0.009298015343249944, 0.7233679515693429, 0.020756295234823315, 0.3972262395319377, 0.014174680920138225, 0.012752967654652976, -0.011589329237296995, 0.003667064295782357, -0.053286023994438894, -0.46706844742444203, 0.009224192776642558, -0.01340419574743183, 0.028394145480301697, -0.013681043083679706, -0.010128568737034539], [-0.9644895884097534, -0.001064862411323605, -0.4513587243013238, -0.01114340152298375, -0.0009188024695418014, -0.00276193076959656, -0.007049118094873679, 0.28012463354884387, 0.0004860538500818593, 0.15007392801528785, -0.003337464715115876, 0.009690425426937113, -0.0058640770173741495, -0.009558317407139024, -0.026091721167155434, -0.46318045771481714, -0.0015038905688482987, 0.0010965642803988042, 0.015766764844416522, -0.006371415282596998, 0.0013455723768746187], [-0.942345938340001, -0.008107583205381868, -0.4727899915783184, 0.0071715551153693465, -0.00594387867714082, -0.0004857132948998184, 0.006197278976247186, -0.3195947113945321, 0.011277466135763234, -0.13875071927806984, -0.02253639681747602, 0.019245369278797594, -0.013186433079758744, -0.025485981096393964, -0.005656820696468763, -0.4844089190982481, -0.00437195469963661, 0.0064972080457730815, 0.005207110180063549, -0.0024556762437875127, 0.004021947838746492], [-0.5702506812521965, -0.02227516583494844, -0.31663301694479057, 0.03200357741415989, -0.01937325830938203, 0.00873633642516486, 0.028459741025265613, -0.8108989713938384, 0.010917477248741163, -0.387587167015775, -0.021285173747511085, 0.017653268222063857, -0.012503145994956786, -0.023722943982657042, -0.0016042422994468166, -0.4915007042861123, -0.004346362477136753, 0.007776113464054274, 0.0030284438254422133, -0.0018429478783778853, 0.0037226270861211983], [0.020946810393359664, -0.032349304682152843, -0.042513500268305776, 0.05068899225563362, -0.02883758551279175, 0.014315242925800333, 0.04500272548155207, -0.9900640293516644, -0.003786991649800575, -0.5024266199764614, 0.0019244053075787595, 0.004020716379422825, -0.004670461613914158, -0.002784388273088343, -0.00037651576265336744, -0.4943609822020366, -0.003863392401234715, 0.007795147368328328, 0.002161957630953363, -0.0014520268147476209, 0.003094960869000672], [0.6038968293460475, -0.02918736494343868, 0.24983026528580915, 0.048488095853382956, -0.026440512239121843, 0.01280138955093967, 0.042861357727568286, -0.7855296020852099, -0.025174014570789705, -0.439893282980709, 0.037498357135975366, -0.01402238045521583, 0.004187389122739071, 0.027589476970111465, -6.831567122241323e-05, -0.4950810518871512, -0.003298233363016728, 0.007154059332752475, 0.0017478496393503505, -0.001088938869120864, 0.00245678908002023], [0.9538754133919461, -0.011074375397180607, 0.4541634210748844, 0.020545448550015562, -0.012076844140777934, 0.006382126599709416, 0.019505614917943212, -0.2767477888078395, -0.04214210322407515, -0.22146383828605132, 0.06759542113711112, -0.026500564210470465, 0.008782572216710641, 0.051462438298528874, -0.0005467224722145035, -0.4936658170658979, -0.0026060584608798535, 0.005677294579018446, 0.0016839425744984273, -0.0006685569433580654, 0.001753044410442544]]
FourierCoefficients = [[1.0535385404898927, 0.01374870731191265, 0.48269444820925067, 0.00021337526588151542, 0.005294359709709023, -0.001884769312093419, 0.020898341686243545, 0.048040639366498675, -0.019840929158445184, 0.06127441276033565, -0.003103545866271599, 0.015038258520674336, 0.0014743734758534627, 0.020082295380199903, 0.009079913326319286, -0.40641858661037567, -0.0037882531785314046, 0.02441605799127917, -0.008762466937081607, 0.002827079443677167, 0.0028161624834141764], [0.6132265323706284, 0.0002898383007789021, 0.305737499229836, 0.0005735171067674253, -0.00399943968566701, -0.0001035195531732516, 0.0009168834246952351, 0.7847986400845737, -0.0004832563553758623, 0.41995427186356543, 0.0010217439616727801, -0.000451025894943299, -0.0003033250005814045, 0.00032088578691323436, -0.0023610781648499696, -0.5172020024261645, 0.00017993434455893697, 0.0034786194070035577, 0.0012881804374188161, 0.001650460017151656, 1.6986842705407253e-06], [0.004756754434740822, -4.676520026226155e-05, 0.003988607858085873, 9.987529064144185e-05, -0.002342534247680914, -2.5894228458707487e-07, 0.000747334370885997, 0.9955956121672821, -7.960504715326954e-05, 0.5070877674415879, 0.0001819948780061926, -0.0023978808855192684, -9.229973013739781e-05, 0.0007568269111620416, -0.00032001962808350654, -0.505436547796484, 7.526958520125312e-05, 0.0025743970665075655, 0.00017239306958103986, 0.00021440315171828214, 2.4130564139327467e-06], [-0.5868158827960783, 5.96637894960172e-06, -0.29163430557464903, 2.8361379512108824e-05, -0.001286370010893441, 1.7036324192872798e-05, 0.0004304998667214675, 0.807750159537732, -2.0016744787551124e-05, 0.40891516434400926, 6.593295759716488e-05, -0.0020100205729322437, -1.6414362979405856e-05, 0.0007150237324556536, -6.056427727538434e-05, -0.5015190845528583, 1.9137218555423494e-05, 0.0010121830487765113, 4.177225362397862e-05, 0.00017440674114000532, 2.1263047724636996e-05], [-0.9515124547929779, 6.847028221983399e-06, -0.4738243828319809, 1.2497807040694927e-05, -0.000800891615498672, 9.206103073799617e-06, 0.0002442827477067048, 0.3084245368698857, 7.153428397805195e-06, 0.15857539769092438, 4.4137700037168317e-05, -0.001988898507680077, 5.409916021265566e-06, 0.0007131576183031353, -7.227770023006155e-06, -0.4996021086120178, 2.8361651341303944e-06, 4.385366757867117e-05, 1.3463173592340783e-05, 0.00024471050857976547, 1.6732369789926915e-05], [-0.9530625057958476, -7.621546397273685e-06, -0.4740806745713868, 6.388683697892702e-06, -0.0004431833765401728, -4.962714526428782e-06, 9.809405733482788e-05, -0.3097067241191928, 2.4319078329825595e-06, -0.14929855499666847, 5.850613716669678e-05, -0.0024465891957259687, 3.797080253901427e-06, 0.0008282073853741595, 2.916877356880693e-05, -0.4976563784144031, -1.0145290799794008e-05, -0.0009157613534256254, -5.337682862746618e-06, 0.000344502570243337, 1.0201697822669792e-05], [-0.5937843336847004, -5.030152172985874e-06, -0.2928525767403452, -1.3941354503988945e-05, 0.00016218818336531654, -2.1432540930571e-05, -0.00010195291145152867, -0.8110337543238024, -4.7453323087996476e-05, -0.3956514242713548, 0.00013817494334823524, -0.003601393815691297, -3.630342880121188e-05, 0.0010746114210415242, 0.00015813776452055622, -0.49382238650136245, -4.849665025237041e-05, -0.002497656593011908, -6.398219448268115e-05, 0.00045743562871723936, 1.3560770263973639e-05], [-0.023117893441729244, -3.018017589740876e-05, -0.001234775556772737, -0.00011868808873417298, 0.0018012342780541171, -2.834162607957662e-05, -0.00033700738204493297, -1.0095600308989112, -0.00020051568225137244, -0.48031548315435585, 0.000561370089995444, -0.0050791195913728725, -0.00022045228162968523, 0.001117717418652503, 0.001046239445918916, -0.4827845257031684, -0.0002134702765624819, -0.005172119619115847, -0.0004929858398072164, -8.514389110458419e-05, 6.654251905316246e-05], [0.4511431024992894, -0.005331893185538722, 0.26214642522304793, -0.0022767228556609407, -0.00045298332928928487, -0.00044372586137831775, 0.00021321729873883608, -0.8799290259308727, -0.0025673774538402827, -0.36889023669228604, 0.0035934654573197993, 0.011754111193039455, 0.0002024222551770505, 0.002509480791006087, 0.010174742013205604, -0.4568528070424867, 0.0010074676873535427, 0.006724366443710413, -0.00515441138850207, -0.005418517185486009, -0.0018750060410128496], [1.7698147382660674, 0.09396486399980891, 0.9215809217022707, 0.11915452655124459, 0.310918077837772, 0.1533811932471241, 0.11216492312389338, 0.2400659453395724, 0.006986415650036442, 0.0361072000441422, 0.00402042381405144, -0.116197815978697, -0.00705854105927818, 0.015074510480105654, -0.16528158476500443, -0.5580644351933309, -0.0916294933142829, -0.3207912877409549, 0.025041954898614823, -0.20378404128681518, -0.024759440360584615]]

N_coils = len(FourierCoefficients)
N_CurvePoints = 1000
FC_order = int((len(FourierCoefficients[0])/3-1)/2)
currents = [1e7]*N_coils


#------------------------------------------------------------------------#
# Setting the initial conditions
#------------------------------------------------------------------------#

def initial_conditions(N_particles: int) -> jnp.ndarray:
    # Alpha particles energy in SI units
    E = 3.52*1.602176565e-13
    # Alpha particles mass in SI units
    m = 4*1.660538921e-27
    # Alpha particles thermal velocity in SI units
    vth = jnp.sqrt(2*E/m)

    # Initializing pitch angle
    seed = 0
    key = jax.random.PRNGKey(seed)
    pitch = jax.random.uniform(key,shape=(N_particles,), minval=-1, maxval=1)
    #pitch = jnp.ones(N_particles)*-0.1
    # Initializing velocities
    vpar = vth*pitch
    vperp = vth*jnp.sqrt(1-pitch**2)

    #x = jnp.array([-0.7])
    #y = jnp.array([ 0.3])
    #z = jnp.array([ 0.3])

    x = jax.random.uniform(key,shape=(N_particles,), minval=-2, maxval=2)
    r = jax.random.uniform(key,shape=(N_particles,), minval=0, maxval=0.5)
    Θ = jax.random.uniform(key,shape=(N_particles,), minval=0, maxval=2*jnp.pi)
    y = r*jnp.cos(Θ)
    z = r*jnp.sin(Θ)

    return jnp.array((x, y, z, vpar, vperp))

InitialValues = initial_conditions(N_particles)
vperp = InitialValues[4]
if debuging:
    print("------------------------------------------------------------------------")
    print(f"x transposed: {jnp.transpose(InitialValues[:3])})")
    print(f"vpar: {InitialValues[3]}")
    print(f"vperp: {vperp}")


#------------------------------------------------------------------------#
# Creating the coils
#------------------------------------------------------------------------#

curves = np.empty(N_coils, dtype=object)
curves_points = jnp.empty((N_coils, N_CurvePoints, 3))
coils = np.empty(N_coils, dtype=object)

for i in range(N_coils):
    # Creating a curve with "NCurvePoints" points and "FCorder" order of the Fourier series
    curves[i] = oldCreateCoil(FourierCoefficients[i], N_CurvePoints, FC_order)
    # Getting the curve points  
    curves_points = curves_points.at[i].set(curves[i].gamma())
    # Creating a coil
    coils[i] = Coil(curves[i], Current(currents[i]))

currents = jnp.array(currents)

#plot3D(N_coils, FourierCoefficients)

#------------------------------------------------------------------------#
# Magnetic Field Calcultions
#------------------------------------------------------------------------#

# Compiling and running the function
B(jnp.transpose(InitialValues[:3])[0], curves_points, currents)
time1 = time()
result_MagneticField = B(jnp.transpose(InitialValues[:3])[0], curves_points, currents)
time2 = time()
normB = jnp.linalg.norm(result_MagneticField)

Stellarator = load("biot_savart_opt.json")
#Stellarator.gamma()

field = BiotSavart(coils)
field.B()
field.set_points(jnp.transpose(InitialValues[:3]))
time3 = time()
result_Simsopt = field.B()
time4 = time()

print("------------------------------------------------------------------------")

print(f"Magnetic Field at {jnp.transpose(InitialValues[:3])[0]}:")

print(f"From trapezoid: {result_MagneticField} took {(time2 - time1):.1e}s")
print(f"Magnetic Field Norm: {jnp.linalg.norm(result_MagneticField)}")

print(f"From SIMSOPT:   {np.array(result_Simsopt)[0]} took {(time4 - time3):.1e}s")
print(f"Magnetic Field Norm: {np.linalg.norm(np.array(result_Simsopt)[0])}")

print("------------------------------------------------------------------------")

# Compiling and running the function
B_novo(jnp.transpose(InitialValues[:3])[0], curves_points, currents)
time1 = time()
result_MagneticField = B_novo(jnp.transpose(InitialValues[:3])[0], curves_points, currents)
time2 = time()
normB = jnp.linalg.norm(result_MagneticField)
print(f"From trapezoid: {result_MagneticField} took {(time2 - time1):.1e}s")
print(f"Magnetic Field Norm: {normB}")

print("------------------------------------------------------------------------")

# Compiling and running the grad function
grad_B(jnp.transpose(InitialValues[:3])[0], curves_points, currents)
time1 = time()
result_gradMagneticField = grad_B(jnp.transpose(InitialValues[:3])[0], curves_points, currents)
time2 = time()
normgradB = jnp.linalg.norm(result_gradMagneticField)
print(f"Grad from trapezoid: {result_gradMagneticField} took {(time2 - time1):.1e}s")
print(f"Grad of Magnetic Field Norm: {normgradB}")

print("------------------------------------------------------------------------")

#------------------------------------------------------------------------#
# Guiding Center Calculations
#------------------------------------------------------------------------#

m = 4*1.660538921e-27
q = 2*1.602176565e-19

# Adiabatic invariant μ
μ = m*vperp**2/(2*normB)
if debuging:
    print(f"μ: {μ}")
    print("------------------------------------------------------------------------")

if debuging:
    for i in range(N_particles):
        time1 = time()
        Dx, Dy, Dz, Dvpar = GuidingCenter(jnp.transpose(InitialValues[:4])[i],0.0,currents, curves_points, μ[i])
        time2 = time()
        print(f"Guiding Center for particle {i+1}:\n Dx: {Dx}\n Dy: {Dy}\n Dz: {Dz}\n Dvpar: {Dvpar}\nTook {(time2 - time1):.1e}s")
        print("------------------------------------------------------------------------")

timesteps = 200
maxtime = 1e-6

print("Number of jax devices: ", jax.device_count())
print("Number of jax local devices: ", jax.local_device_count())
print("------------------------------------------------------------------------")

trajectories = jnp.empty((N_particles, timesteps, 4))
@jit
def trace_trajectory(particle: jnp.int32, InitialValues: jnp.ndarray, times: jnp.ndarray, currents: jnp.ndarray, curves_points: jnp.ndarray, μ: jnp.float32) -> jnp.ndarray:
    return odeint(GuidingCenter, InitialValues[particle], times, currents, curves_points, μ[particle], atol=1e-8, rtol=1e-8, mxstep=100)
@jit
def fori_trace_trajectory(particle: jnp.int32, trajectories: jnp.ndarray) -> jnp.ndarray:
    return trajectories.at[particle,:,:].set(trace_trajectory(particle, jnp.transpose(InitialValues[:4]), jnp.linspace(0, maxtime, timesteps), currents, curves_points, μ))
time1 = time()
#trajectories = vmap(trace_trajectory, in_axes=(0, None, None, None, None, None))(jnp.arange(N_particles), jnp.transpose(InitialValues[:4]), jnp.linspace(0, maxtime, timesteps), currents, curves_points, μ)
#trajectories = pmap(trace_trajectory, in_axes=(0, None, None, None, None, None))(jnp.arange(N_particles), jnp.transpose(InitialValues[:4]), jnp.linspace(0, maxtime, timesteps), currents, curves_points, μ)
#trajectories = jnp.array([odeint(GuidingCenter, jnp.transpose(InitialValues[:4])[0], jnp.linspace(0, maxtime, timesteps), currents, curves_points, μ[0], atol=1e-8, rtol=1e-8, mxstep=1000)])
#for i in range(1, N_particles):
#    trajectories = jnp.concatenate((trajectories, jnp.array([odeint(GuidingCenter, jnp.transpose(InitialValues[:4])[i], jnp.linspace(0, maxtime, timesteps), currents, curves_points, μ[i], atol=1e-5, rtol=1e-5)])), axis=0)
trajectories = fori_loop(0, N_particles,fori_trace_trajectory, trajectories) # THIS IS SLOWER, but can be better for compilation
time2 = time()

if debuging:
    print(trajectories)
print(f"Trajectories took {(time2 - time1):.1e}s")
print(f"Trajectories shape: {trajectories.shape}")
print("------------------------------------------------------------------------")


left_boundary = -2
right_boundary = 2
radial_boundary = 0.7
is_lost = select(jnp.greater(trajectories[:, :, 0], right_boundary*jnp.ones((N_particles,timesteps))) |
                 jnp.less(trajectories[:, :, 0], left_boundary*jnp.ones((N_particles,timesteps))) |
                 jnp.greater(jnp.square(trajectories[:, :, 1])+jnp.square(trajectories[:, :, 2]), radial_boundary*jnp.ones((N_particles,timesteps))),
                 jnp.ones((N_particles,timesteps)), jnp.zeros((N_particles,timesteps)))

@jit
def loss_calc(x: jnp.ndarray) -> jnp.ndarray:
    return 3.5*jnp.exp(-2*jnp.nonzero(x, size=1, fill_value=timesteps)[0]/timesteps)
loss_value = jnp.sum(jnp.apply_along_axis(loss_calc, 1, is_lost))
print("------------------------------------------------------------------------")

print(f"Loss value: {loss_value}")

print("------------------------------------------------------------------------")

#------------------------------------------------------------------------#
# Plotting analysis graphs
#------------------------------------------------------------------------#

plot = True
only_coils = True

#surface = ["cylinder", left_boundary, right_boundary, radial_boundary]
#minor_radius = 1
#major_radius = 2
##surface = ["torus", minor_radius, major_radius]
#plot_animation3d(FourierCoefficients,surface, trajectories, timesteps, show=False, save_movie=True)

FourierCoefficients = jnp.reshape(jnp.array(FourierCoefficients), (N_coils, 3, -1))

if plot:
    if only_coils:
        plot3D(FourierCoefficients)
    else:
        plot3D(FourierCoefficients, trajectories)
    if N_particles > 1:
        raise ValueError("The plotter is not ready for more than one particle")
    NormBScan     = np.empty((N_particles, timesteps))
    NormGradBScan = np.empty((N_particles, timesteps))
    x             = np.empty((N_particles, timesteps))
    y             = np.empty((N_particles, timesteps))
    z             = np.empty((N_particles, timesteps))
    vpar          = np.empty((N_particles, timesteps))
    Dx            = np.empty((N_particles, timesteps))
    Dy            = np.empty((N_particles, timesteps))
    Dz            = np.empty((N_particles, timesteps))
    Dvpar         = np.empty((N_particles, timesteps))
    t             = np.linspace(0, maxtime, timesteps)


    for i in range(N_particles):
        for j in range(len(t)):
            NormBScan[i][j] = B_Norm(trajectories[i][j][:3], curves_points, currents)
            NormGradBScan[i][j] = jnp.linalg.norm(grad_B(trajectories[i][j][:3], curves_points, currents))
            x[i][j], y[i][j], z[i][j], vpar[i][j] = trajectories[i][j][:]
            Dx[i][j], Dy[i][j], Dz[i][j], Dvpar[i][j] = GuidingCenter(trajectories[i][j][:],t[j],currents, curves_points, μ[0])

    plot2D("1x2", (t, t), (NormBScan, NormGradBScan), ("|B|", "|∇B|"), ("", "Time (s)"), ("|B| (T)", "|∇B|"), "B&GradB")
    plot2D("1x1", t, μ[0]*NormBScan+0.5*m*vpar**2, "Energy", "Time (s)", "Energy (J)", "Energy")
    plot2D("1x1", t, np.sqrt(2*m*μ[0]/NormBScan)*NormGradBScan/NormBScan/q, "⍴∇B/B", "Time (s)", "Guiding Center Validity? (⍴∇B/B <<1)", "GC_Validity")
    plot2D("1x3", (t, t, t), (x, y, z), ("x", "y", "z"), ("", "", "Time (s)"), ("Distance (m)", "Distance (m)", "Distance (m)"), "Position")
    plot2D("1x3", (t, t, t), (Dx, Dy, Dz), ("x, y and z derivatives", "", ""), ("", "", "Time (s)"), ("dx (m/s)", "dy (m/s)", "dz (m/s)"), "Position_Derivatives")
    plot2D("1x2", (t, t), (vpar, Dvpar), ("parallel velocity and its derivative", ""), ("", "Time (s)"), ("Velocity (m/s)", "Acceleration (m/s^2)"), "Parallel_Velocity&Derivative")

